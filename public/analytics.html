<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analisis Data Deteksi - Heatmap</title>
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js untuk visualisasi data -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <!-- heatmap.js untuk heatmap -->
    <script src="https://cdn.jsdelivr.net/npm/heatmap.js@2.0.5/build/heatmap.min.js"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: '#3b82f6',
              secondary: '#64748b',
              success: '#10b981',
              danger: '#ef4444',
              warning: '#f59e0b',
              info: '#06b6d4'
            }
          }
        }
      }
    </script>
    <style>
      .grid-container {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        grid-template-rows: repeat(4, 1fr);
        gap: 4px;
        width: 100%;
        height: 400px;
        border-radius: 8px;
        overflow: hidden;
      }
      .grid-cell {
        border: 1px solid #ccc;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        cursor: pointer;
        transition: background-color 0.3s;
        background-color: #f0f9ff;
      }
      .dark .grid-cell {
        border-color: #374151;
        background-color: #1e3a5f;
      }
      .grid-cell-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        z-index: 10;
      }
      .grid-cell-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        opacity: 0.7;
      }
      .zone-indicator {
        font-weight: bold;
        font-size: 18px;
        margin-bottom: 5px;
      }
      .count-indicator {
        font-size: 14px;
      }
      .filter-container {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 15px;
      }
      .chart-container {
        height: 300px;
      }
      /* Scrollbar styling */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }
      ::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #a1a1a1;
      }
      /* Dark mode handling */
      @media (prefers-color-scheme: dark) {
        .dark\:bg-gray-700 {
          background-color: #374151 !important;
        }
        .dark\:bg-gray-800 {
          background-color: #1f2937 !important;
        }
        .dark\:bg-gray-900 {
          background-color: #111827 !important;
        }
        .dark\:text-white {
          color: #fff !important;
        }
        .dark\:text-gray-300 {
          color: #d1d5db !important;
        }
        .dark\:text-gray-400 {
          color: #9ca3af !important;
        }
        .dark\:border-gray-700 {
          border-color: #374151 !important;
        }
      }
      .tooltip {
        position: absolute;
        display: none;
        background-color: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 8px;
        border-radius: 4px;
        font-size: 14px;
        z-index: 1000;
      }
    </style>
  </head>
  <body class="bg-gray-100 dark:bg-gray-900">
    <div class="container mx-auto px-4 py-6">
      <div class="bg-blue-600 text-white p-4 rounded-lg shadow-md mb-6">
        <h1 class="text-2xl font-bold">Analisis Data Deteksi - Heatmap</h1>
        <p class="mt-1">Visualisasi data deteksi berdasarkan zona</p>
        <div class="mt-2">
          <a href="/" class="text-white hover:underline">‚Üê Kembali ke Dashboard</a>
        </div>
      </div>
      
      <!-- Filter Section -->
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-6">
        <h2 class="text-xl font-bold text-gray-800 dark:text-white mb-4">Filter Data</h2>
        <div class="filter-container">
          <div class="w-full sm:w-auto">
            <label for="startDate" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Tanggal Mulai:</label>
            <input type="date" id="startDate" class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white text-sm">
          </div>
          <div class="w-full sm:w-auto">
            <label for="endDate" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Tanggal Akhir:</label>
            <input type="date" id="endDate" class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white text-sm">
          </div>
          <div class="w-full sm:w-auto self-end">
            <button id="applyFilter" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-md text-sm transition-colors mt-4 sm:mt-0">Terapkan Filter</button>
          </div>
        </div>
      </div>
      
      <!-- Heatmap Section -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="lg:col-span-2">
          <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-bold text-gray-800 dark:text-white mb-4">Heatmap Deteksi Lahan</h2>
            <div id="gridContainer" class="grid-container">
              <!-- Grid cells will be populated here -->
            </div>
            <div id="tooltip" class="tooltip"></div>
            <div class="mt-4 text-sm text-gray-500 dark:text-gray-400">
              <p>* Intensitas warna menunjukkan tingkat frekuensi deteksi</p>
            </div>
          </div>
        </div>
        
        <div>
          <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-bold text-gray-800 dark:text-white mb-4">Ringkasan Deteksi per Zona</h2>
            <div class="chart-container">
              <canvas id="zoneChart"></canvas>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Activity Timeline -->
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-6">
        <h2 class="text-xl font-bold text-gray-800 dark:text-white mb-4">Aktivitas Deteksi Terbaru</h2>
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
            <thead class="bg-gray-50 dark:bg-gray-700">
              <tr>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Waktu</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Sensor ID</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Zona</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Status</th>
              </tr>
            </thead>
            <tbody id="activityTableBody" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
              <!-- Data akan diisi secara dinamis -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <script>
      // Variabel global
      let zoneColors = {};
      let zoneChart;
      let zoneData = {};
      let gridHeatmap = [];
      
      // Inisialisasi grid dan chart
      document.addEventListener('DOMContentLoaded', function() {
        initGrid();
        loadData();
        
        // Setup event listeners
        document.getElementById('applyFilter').addEventListener('click', loadData);
      });
      
      // Inisialisasi grid 4x4
      function initGrid() {
        const gridContainer = document.getElementById('gridContainer');
        gridContainer.innerHTML = '';
        
        // Buat grid 4x4 untuk representasi lahan
        for (let row = 0; row < 4; row++) {
          for (let col = 0; col < 4; col++) {
            const cell = document.createElement('div');
            cell.className = 'grid-cell';
            cell.dataset.row = row;
            cell.dataset.col = col;
            
            // Konversi posisi grid menjadi zona (1-16)
            const zoneNumber = row * 4 + col + 1;
            cell.dataset.zone = zoneNumber.toString();
            
            const cellContent = document.createElement('div');
            cellContent.className = 'grid-cell-content';
            
            const zoneIndicator = document.createElement('div');
            zoneIndicator.className = 'zone-indicator text-gray-800 dark:text-white';
            zoneIndicator.textContent = zoneNumber;
            cellContent.appendChild(zoneIndicator);
            
            const countIndicator = document.createElement('div');
            countIndicator.className = 'count-indicator text-gray-600 dark:text-gray-300';
            countIndicator.textContent = '0';
            cellContent.appendChild(countIndicator);
            
            const overlay = document.createElement('div');
            overlay.className = 'grid-cell-overlay';
            
            cell.appendChild(overlay);
            cell.appendChild(cellContent);
            
            // Event listeners untuk tooltip
            cell.addEventListener('mouseover', showTooltip);
            cell.addEventListener('mousemove', moveTooltip);
            cell.addEventListener('mouseout', hideTooltip);
            
            gridContainer.appendChild(cell);
          }
        }
      }
      
      // Tampilkan tooltip saat hover pada grid cell
      function showTooltip(e) {
        const cell = e.currentTarget;
        const zone = cell.dataset.zone;
        const detections = zoneData[zone] || 0;
        
        const tooltip = document.getElementById('tooltip');
        tooltip.innerHTML = `<div>Zona ${zone}</div><div>Jumlah deteksi: ${detections}</div>`;
        tooltip.style.display = 'block';
        moveTooltip(e);
      }
      
      // Pindahkan tooltip mengikuti kursor
      function moveTooltip(e) {
        const tooltip = document.getElementById('tooltip');
        tooltip.style.left = (e.pageX + 10) + 'px';
        tooltip.style.top = (e.pageY + 10) + 'px';
      }
      
      // Sembunyikan tooltip
      function hideTooltip() {
        const tooltip = document.getElementById('tooltip');
        tooltip.style.display = 'none';
      }
      
      // Load data dari API
      async function loadData() {
        try {
          // Get filter values
          const startDate = document.getElementById('startDate').value;
          const endDate = document.getElementById('endDate').value;
          
          // Tambahkan 1 hari ke endDate untuk mendapatkan rentang waktu penuh (hingga tengah malam)
          let endDateForQuery = '';
          if (endDate) {
            const nextDay = new Date(endDate);
            nextDay.setDate(nextDay.getDate() + 1);
            endDateForQuery = nextDay.toISOString().split('T')[0];
          }
          
          // Build API URL with filters
          let url = '/api/detections?';
          if (startDate) url += `startDate=${startDate}&`;
          if (endDate) url += `endDate=${endDateForQuery}&`;
          
          const response = await fetch(url);
          const detections = await response.json();
          
          // Update grid dengan data deteksi baru
          updateGridHeatmap(detections);
          
          // Update chart dengan data zona
          updateZoneChart(detections);
          
          // Update tabel aktivitas
          updateActivityTable(detections);
        } catch (error) {
          console.error('Error loading data:', error);
          alert('Gagal memuat data deteksi. Mohon coba lagi.');
        }
      }
      
      // Update grid heatmap dengan data deteksi
      function updateGridHeatmap(detections) {
        // Reset data zona
        zoneData = {};
        
        // Hitung jumlah deteksi per zona
        detections.forEach(detection => {
          const zone = detection.zone || 'undefined';
          if (!zoneData[zone]) {
            zoneData[zone] = 0;
          }
          zoneData[zone]++;
        });
        
        // Temukan nilai maksimum untuk normalisasi warna
        const maxValue = Math.max(1, ...Object.values(zoneData));
        
        // Update setiap sel grid
        const cells = document.querySelectorAll('.grid-cell');
        cells.forEach(cell => {
          const zone = cell.dataset.zone;
          const detectionCount = zoneData[zone] || 0;
          
          // Update jumlah deteksi di dalam sel
          const countIndicator = cell.querySelector('.count-indicator');
          countIndicator.textContent = detectionCount;
          
          // Warna untuk heatmap (merah untuk deteksi tinggi, hijau untuk rendah)
          const intensity = detectionCount / maxValue;
          const overlay = cell.querySelector('.grid-cell-overlay');
          
          if (detectionCount > 0) {
            // Warna dari hijau ke kuning ke merah berdasarkan intensitas
            const hue = (1 - intensity) * 120; // 120 = hijau, 0 = merah
            overlay.style.backgroundColor = `hsla(${hue}, 100%, 50%, ${Math.min(0.8, intensity + 0.2)})`;
          } else {
            overlay.style.backgroundColor = 'transparent';
          }
        });
      }
      
      // Update chart untuk data zona
      function updateZoneChart(detections) {
        // Process data by zone
        const zoneData = {};
        detections.forEach(detection => {
          const zone = detection.zone || 'Tidak Ada Zona';
          if (!zoneData[zone]) {
            zoneData[zone] = 0;
          }
          zoneData[zone]++;
        });
        
        // Prepare chart data
        const labels = Object.keys(zoneData).sort((a, b) => {
          // Urutkan zona numerik
          if (!isNaN(a) && !isNaN(b)) {
            return parseInt(a) - parseInt(b);
          }
          return a.localeCompare(b);
        });
        const data = labels.map(zone => zoneData[zone]);
        
        // Generate colors for zones
        if (labels.length > Object.keys(zoneColors).length) {
          labels.forEach(zone => {
            if (!zoneColors[zone]) {
              zoneColors[zone] = getRandomColor();
            }
          });
        }
        
        // Create or update chart
        const ctx = document.getElementById('zoneChart').getContext('2d');
        
        if (zoneChart) {
          zoneChart.data.labels = labels;
          zoneChart.data.datasets[0].data = data;
          zoneChart.data.datasets[0].backgroundColor = labels.map(zone => zoneColors[zone]);
          zoneChart.update();
        } else {
          zoneChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
              labels: labels,
              datasets: [{
                data: data,
                backgroundColor: labels.map(zone => zoneColors[zone]),
                borderWidth: 1
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  position: 'right',
                  labels: {
                    color: document.querySelector('html').classList.contains('dark') ? 'white' : 'black'
                  }
                },
                tooltip: {
                  callbacks: {
                    label: function(context) {
                      const label = context.label || '';
                      const value = context.raw || 0;
                      const total = context.dataset.data.reduce((a, b) => a + b, 0);
                      const percentage = Math.round((value / total) * 100);
                      return `${label}: ${value} (${percentage}%)`;
                    }
                  }
                }
              }
            }
          });
        }
      }
      
      // Update activity table with latest detections
      function updateActivityTable(detections) {
        const tableBody = document.getElementById('activityTableBody');
        tableBody.innerHTML = '';
        
        // Sort by detection time, newest first
        const sortedDetections = [...detections].sort((a, b) => 
          new Date(b.detectionTime) - new Date(a.detectionTime)
        );
        
        // Take only the 10 most recent
        const recentDetections = sortedDetections.slice(0, 10);
        
        recentDetections.forEach(detection => {
          const row = document.createElement('tr');
          
          // Format detection time
          const detectionTime = new Date(detection.detectionTime);
          const formattedTime = detectionTime.toLocaleDateString('id-ID') + ' ' + 
                                detectionTime.toLocaleTimeString('id-ID');
          
          // Create table row
          row.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${formattedTime}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${detection.sensorId}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${detection.zone || 'Tidak Ada Zona'}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${detection.status}</td>
          `;
          
          tableBody.appendChild(row);
        });
      }
      
      // Update filter options based on available data
      function updateFilterOptions(detections) {
        // Function ini tidak digunakan lagi karena filter dipersempit
        // Tapi dibiarkan untuk kemungkinan perluasan di masa depan
      }
      
      // Generate random color for chart
      function getRandomColor() {
        const letters = '0123456789ABCDEF';
        let color = '#';
        for (let i = 0; i < 6; i++) {
          color += letters[Math.floor(Math.random() * 16)];
        }
        return color;
      }
      
      // Set default dates (last 7 days)
      function setDefaultDates() {
        const today = new Date();
        const lastWeek = new Date();
        lastWeek.setDate(today.getDate() - 7);
        
        document.getElementById('startDate').valueAsDate = lastWeek;
        document.getElementById('endDate').valueAsDate = today;
      }
      
      // Initialize with default dates
      setDefaultDates();
    </script>
  </body>
</html> 